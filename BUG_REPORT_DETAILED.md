# Bug Report: AST Parsing Failure in lean-dojo-v2

## Summary
The lean-dojo-v2 library (v1.0.0) crashes with an `AssertionError` when attempting to parse AST files generated by Lean v4.25.0, indicating a compatibility issue between the library's expected AST format and the actual format produced by newer Lean versions.

## Environment
- **Lean Version**: v4.25.0
- **lean-dojo-v2 Version**: 1.0.0
- **Python Version**: 3.12
- **Operating System**: Linux (WSL2)
- **Project**: MyNNG (Natural Number Game)

## Error Details

### Stack Trace
```
File "/home/lilixing/Lean-Graph-Analysis/.venv/lib/python3.12/site-packages/lean_dojo_v2/lean_dojo/data_extraction/ast.py", line 134, in _parse_pos
    "synthetic" in info
AssertionError
```

### Failure Point
- **File**: `ast.py`
- **Function**: `_parse_pos()`
- **Line**: 134
- **When**: During parsing of AST JSON files (at ~1% progress, 31/2081 files processed)

## Root Cause Analysis

### The Failing Assertion
The code in `ast.py` lines 120-136 expects position information (`info`) to have one of two formats:

```python
def _parse_pos(info: Dict[str, Any], lean_file: LeanFile) -> Optional[Tuple[Optional[Pos], Optional[Pos]]]:
    if "synthetic" in info and not info["synthetic"]["canonical"]:
        return None

    if "original" in info:
        # Handle original source positions
        start, end = info["original"]["pos"], info["original"]["endPos"]
    else:
        assert (
            "synthetic" in info  # LINE 134 - THIS ASSERTION FAILS
        )  # Expected: | synthetic (pos : String.Pos) (endPos : String.Pos) (canonical := false)
        start, end = info["synthetic"]["pos"], info["synthetic"]["endPos"]

    # ... rest of function
```

### What's Happening
1. The `info` dictionary lacks the `"original"` key (first branch fails)
2. The `info` dictionary also lacks the `"synthetic"` key (assertion fails)
3. This means **Lean v4.25.0 introduced a new AST position format** that lean-dojo-v2 doesn't recognize

### Expected Behavior
According to the code comments, lean-dojo-v2 expects position info in one of these formats:
- **Original**: `{ "original": { "pos": ..., "endPos": ... } }`
- **Synthetic**: `{ "synthetic": { "pos": ..., "endPos": ..., "canonical": ... } }`

### Actual Behavior
Lean v4.25.0 is producing position information in a **third, undocumented format** that doesn't match either pattern.

## Impact

### Build Process
- ✅ Lean project builds successfully (124 jobs completed)
- ✅ AST extraction begins (2235 files queued)
- ❌ Parsing crashes at ~1% (31/2081 files)

### Warnings Before Crash
The log shows 141 files failed to process with "WARNING: Failed to process" messages, but these didn't cause the crash. The crash occurred during the subsequent AST parsing phase.

### Files Affected
Unknown which specific AST file triggered the crash, but it occurred while parsing one of the Lean standard library or dependency files (likely in batteries, lean4, or importGraph packages).

## Version Compatibility Issue

### Known Compatible Versions
Based on context from related files, lean-dojo-v2 v1.0.0 was tested with:
- Lean v4.11.0 ✅ (mentioned in compatibility documentation)

### Problematic Version
- Lean v4.25.0 ❌ (current crash)

### Version Gap
There's a **significant version jump** (4.11.0 → 4.25.0) representing approximately 14 minor versions, during which Lean's AST format likely evolved.

## Reproduction Steps

1. Set up Lean project with v4.25.0 toolchain:
   ```bash
   echo "leanprover/lean4:v4.25.0" > lean-toolchain
   ```

2. Install lean-dojo-v2:
   ```bash
   pip install lean-dojo-v2
   ```

3. Attempt to trace the repository:
   ```python
   from lean_dojo_v2.lean_dojo.data_extraction.lean import LeanGitRepo
   from lean_dojo_v2.lean_dojo.data_extraction.trace import trace

   repo = LeanGitRepo.from_path("path/to/lean/project")
   traced_repo = trace(repo)  # CRASHES HERE
   ```

## Technical Details

### AST Parsing Flow
1. `trace(repo)` → builds project and extracts AST to `.ast.json` files
2. `TracedRepo.from_traced_files()` → begins parsing 2081 AST files
3. `TracedFile.from_traced_file()` → processes individual files
4. `FileNode.from_data()` → recursively parses AST nodes
5. `AtomNode.from_data()` → parses leaf nodes with position info
6. `_parse_pos()` → **CRASHES** due to unrecognized position format

### Missing Information
The error doesn't reveal:
- Which specific AST file triggered the crash
- What the actual structure of the problematic `info` dictionary is
- Whether this is an isolated case or systematic across all v4.25.0 AST files

## Workarounds

### Option 1: Downgrade Lean Version
Downgrade from v4.25.0 to v4.11.0 (confirmed compatible):
```bash
echo "leanprover/lean4:v4.11.0" > lean-toolchain
lake update
```
**Pros**: Guaranteed compatibility
**Cons**: Loses access to newer Lean features; may break existing code using v4.25.0 features

### Option 2: Wait for lean-dojo-v2 Update
Wait for lean-dojo-v2 maintainers to add support for Lean v4.25.0
**Pros**: Keeps current Lean version
**Cons**: Blocks current work indefinitely

### Option 3: Patch lean-dojo-v2
Modify the `_parse_pos()` function to handle the new format
**Pros**: Unblocks immediate work
**Cons**: Requires understanding new format; maintenance burden; unofficial patch

## Recommendations

### For Users
1. **Immediate**: Downgrade to Lean v4.11.0 for compatibility
2. **Short-term**: Monitor lean-dojo-v2 repository for v4.25.0 support
3. **Long-term**: Check lean-dojo-v2 compatibility matrix before upgrading Lean

### For lean-dojo-v2 Maintainers
1. **Document** officially supported Lean versions
2. **Investigate** AST format changes between v4.11.0 and v4.25.0
3. **Update** `_parse_pos()` to handle new position formats
4. **Add** better error messages showing actual vs expected format
5. **Implement** version compatibility checks with clear error messages
6. **Create** regression tests for multiple Lean versions

### For Debugging (If Fixing)
1. Capture the actual `info` dictionary contents when assertion fails
2. Compare AST output between Lean v4.11.0 and v4.25.0
3. Review Lean v4 changelog for AST format changes
4. Test intermediate versions to pinpoint when format changed

## Related Issues
- This appears related to API/format stability in Lean 4
- May affect other tools that parse Lean AST files
- Similar issues likely exist for versions between 4.11.0 and 4.25.0

## References
- Test script: `experiments/MyNNG/test_build_graph.py`
- Failing code: `.venv/lib/python3.12/site-packages/lean_dojo_v2/lean_dojo/data_extraction/ast.py:134`
- Project toolchain: `experiments/MyNNG/MyNNG/lean-toolchain`
